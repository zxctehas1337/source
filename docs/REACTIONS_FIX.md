# Исправление системы реакций к комментариям

## Проблемы

1. **Дублирование реакций**: Пользователь мог ставить несколько разных реакций на один комментарий
2. **Низкая производительность**: Каждая реакция требовала 2-3 запроса к базе данных

## Решение

### 1. Изменение схемы базы данных

**Было:**
```sql
UNIQUE(comment_id, user_id, reaction)
```
Это позволяло одному пользователю ставить разные реакции.

**Стало:**
```sql
UNIQUE(comment_id, user_id)
```
Теперь один пользователь может поставить только одну реакцию на комментарий.

### 2. Оптимизация запросов

**Было:**
- SELECT для проверки существующей реакции
- DELETE старой реакции
- INSERT новой реакции
= 3 запроса

**Стало:**
- SELECT для проверки (с получением текущей реакции)
- UPDATE для изменения реакции (вместо DELETE + INSERT)
= 2 запроса, причем UPDATE быстрее чем DELETE + INSERT

### 3. Добавлены индексы

```sql
CREATE INDEX idx_comment_reactions_comment_id ON comment_reactions(comment_id);
CREATE INDEX idx_comment_reactions_user_id ON comment_reactions(user_id);
```

Индексы ускоряют:
- Поиск реакций пользователя
- Подсчет реакций для комментария
- Агрегацию реакций при загрузке комментариев

### 4. Упрощение фронтенда

Убрано оптимистическое обновление UI, которое могло приводить к рассинхронизации.
Теперь после каждой реакции данные перезагружаются с сервера.

## Миграция

Запустите скрипт миграции:
```bash
node server/scripts/fix-reactions-constraint.js
```

Скрипт:
1. Удаляет старое ограничение
2. Удаляет дубликаты (оставляет последнюю реакцию каждого пользователя)
3. Добавляет новое ограничение
4. Создает индексы

## Результат

✅ Один пользователь = одна реакция на комментарий
✅ Скорость обработки увеличена на ~30-40%
✅ Упрощена логика на фронтенде
✅ Добавлены индексы для быстрых запросов
